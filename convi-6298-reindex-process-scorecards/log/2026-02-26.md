# Project Log - 2026-02-26

## Progress

- Completed Approach 3 go-servers implementation
- Reset go-servers branch to main (reverted Approach 2 committed changes)
- Created new `reindexscorecards/` package with workflow, activity, and const files
- Created job handler and wired up registry + registration
- Updated cron task with `REINDEX_MODE` env var for dispatching to new job type
- Fixed proto comment inconsistency (default scorecard type is PROCESS)

## Details

### Files Created

| File | Purpose |
|------|---------|
| `temporal/ingestion/reindexscorecards/const.go` | Task queue name + env flags (batch size, max attempts, heartbeat timeout) |
| `temporal/ingestion/reindexscorecards/workflow.go` | Temporal workflow following `reindexconversations` pattern |
| `temporal/ingestion/reindexscorecards/activity.go` | `ReindexScorecardsActivity` — fetches process scorecards from PG, writes to CH |
| `temporal/ingestion/reindexscorecards/BUILD.bazel` | Bazel build file |
| `apiserver/internal/internaljob/jobhandler/reindex_scorecards_handler.go` | Job handler for `JOB_TYPE_REINDEX_SCORECARDS` |

### Files Modified

| File | Change |
|------|--------|
| `jobhandler/registry.go` | Added `JOB_TYPE_REINDEX_SCORECARDS` → `NewReindexScorecardsHandler` |
| `jobhandler/BUILD.bazel` | Added handler source + `//temporal/ingestion/reindexscorecards` dep |
| `temporal/registration/registration.go` | Added `reindexScorecardsRegistration` function + task queue entry |
| `temporal/registration/BUILD.bazel` | Added `//temporal/ingestion/reindexscorecards` dep |
| `cron/task-runner/tasks/batch-reindex-conversations/task.go` | Added `REINDEX_MODE` env var (conversation/process/all), dispatches to new job |

### Activity Logic

The `ReindexScorecardsActivity` does:
1. Parses config (time range, scorecard types, batch size, clean_up flag)
2. Defaults to PROCESS scorecards if no types specified
3. For each scorecard type:
   - Counts scorecards via JOIN on `director.scorecards` + `director.scorecard_template_revisions` (filtered by type)
   - Batch loop: fetch scorecards, fetch `historic.scorecard_scores` per scorecard
   - Optionally delete CH data (`DeleteScoresOnShard`/`DeleteScorecardOnShard` with `isConvoTemplate=false`)
   - Write to CH (`WriteScores` with `isProcessScorecard=true`, `WriteScorecards`)
   - Heartbeat after each batch for resumption

### Key Design Decisions

- **Sequential batching**: Conservative approach; process scorecards are lower volume
- **Heartbeat resumption**: Tracks `ProcessedCount` to resume from last batch on restart
- **DI**: `ClickHouseClient` injected via `registration.go` (same pattern as retention activities)
- **Cron task**: `REINDEX_MODE=conversation` (default) preserves existing behavior; `process` or `all` triggers new job

## Next Steps

- [ ] Commit and push both repos
- [ ] Update PR descriptions
- [ ] Build verification with Bazel
- [ ] Update README with final state
