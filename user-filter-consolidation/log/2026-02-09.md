# Project Log - 2026-02-09

## Progress

- Re-evaluated the entire project against the current go-servers codebase
- Created `evaluation-2026-02-09.md` with full findings

## Details

### Key Findings

1. **The original unification plan (merge into shared/user-filter) has not been executed.** Instead, the team took an incremental approach: migrating APIs one by one to `ParseUserFilterForAnalytics`.

2. **Migration is ~41% complete**: 12 out of ~29 APIs now use `ParseUserFilterForAnalytics`. 17 APIs still use the old 3-step pattern (ApplyResourceACL + ListUsersMappedToGroups + MoveFiltersToUserFilter).

3. **Feature flag still active**: `ENABLE_PARSE_USER_FILTER_FOR_ANALYTICS` gates the new path.

4. **All analysis documents remain accurate**: The unused params, cache analysis, and function comparison docs are still valid.

5. **New developments since analysis**: `ShouldQueryAllUsers` flag, `ApplyUserFilterFromResult` helper, UNION semantics fix for group expansion.

### Recommendation (revised)

Unification first approach is better — avoids touching ~17 APIs twice. Build behavioral standard first, align with team, then unify.

### Behavioral Standard Created (v2 — updated with non-test evidence)

Created `user-filter-behavioral-standard.md` with:
- 45+ numbered behaviors across 19 sections
- Evidence from: unit tests, implementation code, AND caller usage patterns
- New sections added from non-test code review:
  - **Section 11: Group Hierarchy and Child Teams** (B-GH-1 to B-GH-4) — from `ListGroups` implementation
  - **Section 13: Caller Contract** (B-CC-1 to B-CC-5) — from `retrieve_*_stats.go` caller patterns
  - **Section 18: Profile Scoping** (B-PS-1, B-PS-2) — from cross-profile bug comment
- Key behaviors found ONLY in implementation code (not tests):
  - B-CF-1 divergence: old pattern uses UNION for user+group, new uses INTERSECTION (most significant)
  - B-SO-1: sort key divergence (Name vs FullName)
  - B-DU-4: ListUsersMappedToGroups hardcodes IncludeInactiveUsers=true
  - B-CC-2: missing UserNameToGroupNamesMap entries silently drop user stats from response
  - B-GF-6: invalid group names silently skipped in filterUsersByGroups
  - B-SO-3: non-deterministic map iteration in unionUsers/convertLiteUsersToUsers
- 9 behavioral divergences identified (up from 6), including `hasAgentAsGroupByKey` coupling
- Appendix B lists 15 behaviors found only from non-test code

### hasAgentAsGroupByKey Analysis & Removal Proposal (v3)

Added Sections 20 and 21 to the behavioral standard:

**Section 20 — Remove `hasAgentAsGroupByKey` from user filter:**
- Flag bundles 3 unrelated concerns: root/default inclusion, force direct-only, group filter bypass
- Name describes caller's grouping strategy, not a user filter behavior
- Proposed: user filter returns complete data, callers post-process

**Section 21 — Post-processing utilities:**
- `StripRootAndDefaultGroups` — strip root/default from user-to-group maps
- `FilterGroups` / `FilterMappingByGroups` — restrict groups to an allowlist
- `ClearGroupMembers` — strip membership data for responses
- `UserNamesFromResult` / `UserIDsFromResult` — extract names/IDs for coaching
- `ApplyToQuery` — apply result to WHERE clause (replaces ApplyUserFilterFromResult)
- Documented 4 typical caller patterns: agent leaderboard, team leaderboard, time-range only, coaching

**Updated existing sections:**
- Section 2 (Inputs): reorganized into 4 categories (Scoping Context, User Selection, Population Filter, Membership Resolution). Identified 3 redundancies: `listAgentOnly` ≡ `Roles=[AGENT]`, `excludeDeactivatedUsers` ≡ `State=ACTIVE`, `DirectTeamOnly` ≡ `includeDirectGroupMembershipsOnly`. Proposed unifying each pair.
- Section 3 (Outputs): restructured into Core Outputs (complete data) + Derived Outputs (via utilities)
- Section 10 (B-GM-1 through B-GM-6): rewritten to remove `hasAgentAsGroupByKey` coupling
- Section 19: added Divergence 9
- Section 4 (B-ACL-4, B-ACL-5): added explanation of why UNION semantics and group expansion are required, with concrete examples of what goes wrong without them (intersection bug, data leakage, silent data loss)
- Section 5 (B-BP-1, B-BP-3, B-BP-4): added explanation of why base population is fetched first instead of gradually adding users. Documented three bug classes: role filtering bypass, status filtering bypass, inconsistent metadata. Added concrete examples of limited-access data leakage and two-user-list divergence.
- Renamed "ground truth" → "base population" throughout. The term better describes the concept: it's the initial user set from `ListUsersForAnalytics` that provides a quick server-side filter, after which more complex custom logic (ACL, membership resolution) is applied. Variable name `groundTruthUsers` in code noted for reference.
- Updated Context (line 7) to describe the three current implementation locations and the migration goal.
- Updated Terminology to explain that base population leverages `ListUsersForAnalytics` for simple server-side filtering, with complex logic performed afterward.

### Terminology Rename: "user filter"/"group filter" → "selected users"/"selected groups"

Renamed throughout the behavioral standard where the terms refer to **input selections** (what the end user picked in the request). Preserved the original terms where they refer to:
- The user filter **package/system/function** (e.g., "the user filter should return...")
- Function names (e.g., `ParseUserFilterForAnalytics`, `MoveFiltersToUserFilter`)
- Internal API parameters (e.g., "team group filter" in `ListUsers` fetch)
- Direct code quotes in implementation evidence

Sections updated:
- Section 5 (B-BP-1): "ACL, selected users, selected groups intersect"
- Section 6: B-UF-1 through B-UF-3 headers renamed
- Section 7: B-GF-1, B-GF-3, B-GF-4 headers renamed
- Section 8: Renamed to "Combined User + Group Selections", B-CF-1/B-CF-3 headers and body text updated
- Section 10 (B-GM-5): "regardless of selected groups"
- Section 11 (B-GH-4): "no groups are selected"
- Section 12: Table headers renamed to "Selected Users"/"Selected Groups"
- Section 18 (B-PS-2): "no groups are selected"
- Section 19 (Divergence 5): "Selected Users + Selected Groups Semantics"
- Section 20: "Bypass selected groups for GroupsToAggregate"
- Section 21: Clarified ApplyToQuery comments
- Appendix B: Updated B-GM-5 and B-CF-3 descriptions

### B-ACL-2 Clarification

Rewrote B-ACL-2 from "Limited Access Overrides Input Filters" to "Limited Access Narrows Selections to Managed Set". The old wording ("managed users/groups replace the request's selections, regardless of what was requested") was misleading — it implied managed users/groups are arbitrary. In reality, `applyUserFilters` and `applyGroupFilters` in `acl_helper.go` **intersect** the managed set with the request's selected set. The ACL result is always a subset of the selections:
- Non-empty selection: `selected ∩ managed`
- Empty selection: all managed users/groups
Added a table showing both cases and implementation evidence from `acl_helper.go:456` and `acl_helper.go:429`.
- Appendix B: Updated B-GM-5 and B-CF-3 descriptions

### B-BP-2 Update

Rewrote B-BP-2 to clarify that base population flags are determined by what `ListUsersForAnalytics` natively supports as server-side filters. Currently only `listAgentOnly` (→ `AgentOnly`) and `excludeDeactivatedUsers` (→ `IncludeInactiveUsers`) are supported. Added a "Future expansion" note: as the API adds support for more criteria (e.g., `Roles`, `UserTypes`), corresponding population filters should be pushed down into this call to reduce base population size early.

### Sections 6, 7, 8 Restructured

Merged old Sections 6 (User Filtering), 7 (Group Filtering), and 8 (Combined User + Group Selections) into two cleaner sections:

**New Section 6: Selection Filtering** — General behaviors that apply uniformly to both user and group selections:
- B-SF-1: Empty Selection = All Accessible Users (was B-UF-1, now covers both)
- B-SF-2: Selection Restricts Results (was B-UF-2, now covers both user and group)
- B-SF-3: Combined User + Group Selections Use UNION (**decision: UNION**, was B-CF-1 divergence)
- B-SF-4: Non-Existent Entries Silently Dropped (was B-UF-3, now covers both)
- B-SF-5: Invalid Resource Names Return Error (was B-UF-4 + B-GF-5, merged)
- B-SF-6: Selection Filtering Works in All ACL States (was B-GF-4, generalized)

**New Section 7: Group Selection Mechanics** — Group-specific processing before general rules apply:
- B-GS-1: Groups Expand to Member Users (was B-GF-1)
- B-GS-2: Group Types Handled Separately (was B-GF-2)
- B-GS-3: Direct Membership Respected (was B-GF-3)
- B-GS-4: Unparseable Group Names Silently Skipped During Expansion (was B-GF-6)

**Removed behaviors:**
- B-CF-2 (Multi-Source Selection Uses Union) — just deduplication, implicit in B-SF-3
- B-CF-3 (Deactivated Filter Combined with Selected Groups) — redundant with base population approach; deactivated users are already excluded from base population before selection filtering happens

**Other updates:**
- Divergence 5 updated: decision is UNION, `ParseUserFilterForAnalytics` will be corrected
- Appendix A and B updated with new behavior IDs
- All sections renumbered (old 9-21 → 8-20) for continuity
- Cross-references updated

### Section 8 (Deactivated User Handling) Simplified

Merged B-DU-1 (base population pattern) and B-DU-2 (post-filtering pattern) into a single B-DU-1: "Deactivated Users Excluded When Flag Is Set." Both patterns produce the same result — the implementation detail of how exclusion happens is not a behavioral concern. Removed B-DU-4 (ListUsersMappedToGroups hardcodes IncludeInactiveUsers=true) — old-pattern implementation detail, not a behavioral spec. Renumbered B-DU-3 → B-DU-2.

### Clarified Two Directions in Sections 7, 9 (Group Selection Mechanics, Group Membership Tracking)

Clarified that `includeDirectGroupMembershipsOnly` / `DirectTeamOnly` operates in two independent directions:

1. **Group→User (expansion)**: the flag controls which users qualify as members of a selected group. When true, only direct members are included. Both flags map to `IncludeIndirectGroupMemberships=false` in `ListUsersForAnalytics`/`ListUsers`. Verified they work identically.

2. **User→Group (mapping)**: once a user is in the result, their group memberships are ALWAYS fully tracked in both `UserNameToDirectGroupNames` and `UserNameToAllGroupNames`, regardless of the flag. The flag narrows which users are present, not which groups appear per user.

Updated behaviors:
- B-GS-3: Renamed to "Direct Membership Controls Group→User Expansion", added concrete example showing both directions
- B-GM-1: Renamed to "Track Both Direct and Indirect Memberships (User→Group Direction)", clarified independence from the flag
- B-GM-4: Renamed to "Callers Choose Which Map to Use", clarified that current `buildUserGroupMappings` only has one map so flag necessarily controls it; proposed two-map design makes flag unnecessary for mapping

### Struct-Based Outputs and Conversion Utilities

Updated Section 3 (Outputs) and Section 20 (Post-Processing Utilities):

**Outputs now use `LiteUser`/`LiteGroup` structs** instead of plain resource name strings. Since `ListUsersForAnalytics` already returns these with metadata (Username, FullName, GroupType), returning structs means callers that need metadata get it for free — no extra RPC calls. Renamed output fields:
- `UserNameToDirectGroupNames` → `UserToDirectGroups` (struct-based)
- `UserNameToAllGroupNames` → `UserToAllGroups` (struct-based)
- `GroupNameToDirectMembers` → `GroupToDirectMembers` (struct-based)
- `GroupNameToAllMembers` → `GroupToAllMembers` (struct-based)

**Added conversion utilities** for callers that don't need metadata:
- `UserNames([]LiteUser) → []string` — extract resource names
- `UserIDs([]LiteUser) → ([]string, error)` — extract IDs
- `GroupNames([]LiteGroup) → []string` — extract resource names
- `UserToGroupNamesMap(map[LiteUser][]LiteGroup) → map[string][]string` — convert struct map to string map

Updated caller patterns and B-CC-4 to reflect struct-based outputs with conversion.

### Section 16 (Sorting) — Decision: Resource Name

Decided sort key: always sort by resource name. Merged old B-SO-1 (divergence) and B-SO-2 (groups sorted by name) into a single B-SO-1: "Users and Groups Sorted by Resource Name." Resource names are stable identifiers. Old B-SO-3 renumbered to B-SO-2. Updated Divergence 6 to show decision. Removed sort key divergence from Appendix B (no longer an open question).

### Removed `FilterGroups`, `FilterMappingByGroups`, and `ClearGroupMembers` Utilities

Removed three proposed utilities from Section 20:

- **`FilterGroups`**: Redundant — callers can use `result.FinalGroups` (already filtered to selected groups) instead of filtering `AllGroups` themselves. Verified no current caller does post-parse group filtering.
- **`FilterMappingByGroups`**: No current caller restricts the user-to-groups mapping after receiving it. Callers can iterate over `FinalGroups` during aggregation instead.
- **`ClearGroupMembers`**: Unnecessary — `LiteGroup` is a lightweight struct without member lists, so there's nothing to clear. The old pattern of `group.Members = []*userpb.GroupMembership{}` was needed because the full proto `Group` object contained members.

Updated caller patterns:
- Agent leaderboard: uses `result.AllGroups` directly (no `ClearGroupMembers`)
- Team leaderboard: uses `result.FinalGroups` instead of `FilterGroups(result.AllGroups, requestedGroups)`, removed `FilterMappingByGroups`
- Section 19 "After (proposed)" example: updated to match

### Consistency Review

Full-document review for stale references and inconsistencies. Fixed 15 issues:

**Stale field names updated:**
- B-BP-3: `UsersFromGroups, UserNameToGroupNamesMap` → `UserToDirectGroups, UserToAllGroups, GroupToDirectMembers, GroupToAllMembers`
- B-GS-3 example: `UserNameToDirectGroupNames/UserNameToAllGroupNames` → `UserToDirectGroups/UserToAllGroups`
- B-GM-1: same rename
- B-GM-4: same rename
- B-CC-2 heading: `UserNameToGroupNamesMap Used for Response JOIN` → `User-to-Groups Mapping Used for Response JOIN`
- B-CC-3 heading: `GroupsToAggregate Used as Aggregation Buckets` → `Groups Output Used as Aggregation Buckets`
- Section 19 "After" comments: `UserNameToDirectGroupNames/UserNameToAllGroupNames` → `UserToDirectGroups/UserToAllGroups`

**Removed utility references:**
- Section 3 Derived Outputs: `FilterGroups(AllGroups, requestedGroups)` → `Use FinalGroups directly`
- B-GM-5: `FilterGroups() utility` → `FinalGroups`
- Divergence 9: "callers filter with utility" → "callers use `FinalGroups` for selected subset"

**Content fixes:**
- Line 104: "base population population" → "base population" (doubled word)
- Section 2 DirectMembershipsOnly: removed claim it's "used in output mapping" (contradicts B-GM-4)
- B-ACL-1 table: "Input filters are overridden" → "Narrow selections to managed set" (consistent with B-ACL-2)
- B-GM-6: updated for LiteGroup — clearing Members is now moot
- Divergences header: "team must decide" → "each divergence includes the decided canonical behavior"

**Appendix B updates:**
- B-GM-5: "GroupsToAggregate filtered by selected groups" → "AllGroups unfiltered; callers use FinalGroups"
- B-GM-6: "Group Members cleared in output" → "No membership data in group output (moot with LiteGroup)"
- B-CC-2: "Missing map entries" → "Missing user-to-groups map entries"
- B-CC-4: "only use UserNames" → "only use user IDs"
