# Project Log - 2026-02-26

## Progress

- Investigated per-criterion quintile ranking requirements for BE API
- Confirmed response structure: flat array with composite `QAScoreGroupBy` (both `user` and `criterionId` populated)
- Confirmed criterion filtering already supported via `filterByAttribute.criterionIdentifiers`
- Identified gap: `setQuintileRankForPerAgentScores` pools ALL agent rows together regardless of criterion
- **Implemented Option A** in go-servers worktree `go-servers-quintiles-criterion` (branch `feature/agent-quintiles-per-criterion`)
  - Refactored `setQuintileRankForPerAgentScores` to partition by `criterionId` before ranking
  - Extracted `assignQuintileRanks` helper function
  - Added 5 new tests: PerCriterion_5Agents2Criteria, DifferentRankPerCriterion, AgentOnly_BackwardCompatible, TiesWithinCriterion, SingleCriterion
  - All 15 tests pass (9 existing + 5 new + 1 backward-compat)
- Investigated FE changes needed (see details below)
- Created detailed investigation doc: `per-criterion-quintile-investigation.md`

## Details

### BE implementation
Key findings:
1. When grouped by `[AGENT, CRITERION]`, the response is a flat array where each entry has both `user` and `criterionId` set in `groupedBy`
2. Old `setQuintileRankForPerAgentScores` only checked `User != nil`, ignoring `criterionId` — ranked all agent rows in one pool
3. Fix: partition by `criterionId` first, then call `assignQuintileRanks` per group. When no criterion grouping, `criterionId = ""` → single group → same as today
4. No proto/API changes needed. No call site changes. ~20 lines of Go code.

### FE changes needed
Only Performance and Leaderboard have tables with a criterion dropdown. Per-criterion quintile only applies there. Coaching Hub, Coaching Plan, and agent-only leaderboards keep overall quintile (unchanged).

**No changes needed:** `transformersQAI.ts`, `AgentLeaderboard`, `AgentLeaderboardByMetric`, Coaching Hub, Coaching Plan

**Changes needed (criterion dropdown table only):**
- `LeaderboardPerCriterion.tsx` (3rd table) — quintile request should group by `[AGENT, CRITERION]` when criterion selected; use composite key `agentName:criterionId`

### BE PR
- [go-servers #25968](https://github.com/cresta/go-servers/pull/25968) — Per-criterion quintile ranking

### "Always GROUP BY agent_user_id" workload investigation
- Analyzed all 13 Analytics API ClickHouse query files for GROUP BY patterns
- Categorized: 0 Category A (already always), 12 Category B (optional, needs change), 1 Category C (LiveAssistStats, special UNION ALL pattern)
- Key finding: COUNT(DISTINCT conversation_id) re-aggregation is a correctness landmine (conversations shared by agents → over-counting)
- Estimated ~19-20 engineering days total
- **Recommendation: Do NOT pursue this approach.** WHERE-clause filtering (CONVI-6247 `listAgentOnly` approach) is ~13x less work with no aggregation risk
- Created doc: `always-group-by-agent-investigation.md`

### FE GroupBy usage pattern investigation
- Comprehensive search of director codebase for all `groupByAttributeTypes` / `GroupByAttributeTypes` usage
- Cataloged every analytics API call across Performance page, Leaderboard pages, Assistance Insights, and Coaching Hub
- Key findings:
  - **Empty groupBy `[]`**: Assistance Insights overview cards (ConversationStats, KnowledgeAssistStats, HintStats) use empty array for totals
  - **`[TIME_RANGE]` only**: Performance Score chart, Performance Score metric card, Conversation Count chart, Performance Progression "All criteria" row
  - **`[CRITERION, TIME_RANGE]`**: Performance Progression heatmap rows, Outcome stats cards
  - **`[AGENT, GROUP]`**: Agent Leaderboard page (all non-QA APIs), Assistance Insights agent tables
  - **`[AGENT]`**: Manager Leaderboard (non-QA), QA score on Agent Leaderboard, Coaching Hub goal popover, LeaderboardPerCriterion quintile
  - **`[GROUP]`**: Team Leaderboard page (all non-QA APIs)
  - Leaderboard Statistics summary cards reuse the SAME request as the agent table (they extract aggregate fields from the response)
  - `filterToAgentsOnly` is currently only passed by Agent Leaderboard and Team Leaderboard; NOT by Performance page or Assistance overview
- Created doc: `fe-group-by-usage-patterns.md`

### ClickHouse `ext` (external data tables) feasibility investigation
- Investigated whether `clickhouse-go/v2/ext` package can be adopted for passing in-memory filter tables with queries
- Key findings:
  - **Driver:** `github.com/ClickHouse/clickhouse-go/v2` v2.34.0 — `ext` package ships with it
  - **Connection API:** Native (`driver.Conn` via `clickhouse.Open`), not `database/sql` — fully compatible with `ext`
  - **Query execution:** All 19 ClickHouse query files in analyticsimpl use `clickhouseshared.QueryWithRetry(ctx, conn, chQuery, chArgs...)`
  - **Context merging:** Verified that `clickhouse.Context` preserves `.external` tables when nested — `createClickhouseContext` only sets `.queryID`, so pre-attached ext tables survive through the retry wrapper
  - **Verdict:** Zero changes needed to `common.go` or shared layer. Caller just attaches ext table to ctx before calling `QueryWithRetry`.
- Created doc: `clickhouse-ext-tables-investigation.md`
