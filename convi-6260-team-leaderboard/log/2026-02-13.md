# Project Log - 2026-02-13

## Progress

- Read knowledge docs on `ParseUserFilterForAnalytics` and user filter consolidation
- Read Linear issue CONVI-6260
- Investigated both old and new code paths for team leaderboard
- Identified root cause: `buildUserGroupMappings` uses `FetchGroups` (no child expansion) instead of `ListGroups` (expands children)
- Confirmed feature flag `ENABLE_PARSE_USER_FILTER_FOR_ANALYTICS` is enabled in production (except Schwab), making the new path active
- Wrote full root cause analysis document

## Details

The bug is in `buildUserGroupMappings` (`common_user_filter.go:375-398`). The old path called `shared.ListGroups` which set `IncludeGroupMemberships: true` and iterated members to find child groups (lines 740-757). The new path replaced this with `userfilter.FetchGroups` which only returns explicitly requested groups with no child expansion. The `slices.Contains` check at line 433 then blocks sub-teams from `groupsToAggregate`.

Affects all 12 migrated APIs (RetrieveAgentStats, RetrieveConversationStats, etc.) on all non-Schwab clusters. `RetrieveAssistanceStats` is unaffected (always uses old path).

### Cross-pollination with User Filter Consolidation

Captured the finding into the user-filter-consolidation project:
- Added **B-GH-4** behavior and **Divergence 10** to the behavioral standard
- Updated implementation plan (Phase 1 PR 1.3 and Phase 3 PR 3.3)
- Added `B_GH_4_ChildTeamsMissingFromGroupsToAggregateBug` test to PR #25705 (Phase 1 behavioral tests), asserting the current broken behavior. The unified implementation will fix this.

### Fix implemented

- Created worktree `go-servers-convi-6260` on branch `convi-6260-hilton-performance-assistance-insights-team-leaderboard-not`
- Replaced `userfilter.FetchGroups` with `shared.ListGroups` in `buildUserGroupMappings`
- Removed unused `userfilter` import
- Reproduced the bug with `RetrieveQAScoreStats` on `cresta/walter-dev` (groupBy `QA_ATTRIBUTE_TYPE_GROUP` with parent team "xuanyu" â€” only parent returned, no sub-teams)
- Updated test mock (`setupListGroupsMock`) to match `shared.ListGroups` call pattern (PageSize=200, no ProfileId)
- All 32 `TestParseUserFilter` tests pass
- Pushed and created PR: https://github.com/cresta/go-servers/pull/25733
