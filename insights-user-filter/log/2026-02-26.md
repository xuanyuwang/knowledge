# Project Log - 2026-02-26

## Progress

- Analyzed recurring bug: empty user filter returns non-agent data, FE shows "unknown" user names
- Created `empty-filter-non-agent-data-bug.md` with root cause analysis
- Investigated all 13 API ClickHouse query patterns to validate fix approach
- **Revised fix**: centralized one-line change in `ParseUserFilterForAnalytics` (rejected per-API post-query filtering)
- Investigated ClickHouse techniques for large IN clauses → `general-learnings/clickhouse-large-in-clause-techniques.md`
- Investigated workload of always-GROUP-BY-agent approach → `always-group-by-agent-investigation.md`
- Investigated FE group-by usage patterns → `fe-group-by-usage-patterns.md`

## Details

### Bug: Non-Agent Data When User Filters Empty

Third time the `ShouldQueryAllUsers` vs `listAgentOnly` tension surfaces. See `empty-filter-non-agent-data-bug.md` for full analysis.

**Recommended fix**: One-line change in `common_user_filter.go:226-227` — add `&& !listAgentOnly` to `shouldUseAllAgents`.

### ClickHouse Large IN Clause Techniques

Four approaches investigated:
1. **Increase `max_query_size`** (quick fix, per-query setting, default 256KB → 10MB)
2. **External Data Tables** (recommended production solution — Go driver `ext` package, bypasses size limit entirely)
3. **Temporary Tables** (works but not connection-pool safe)
4. **Slice Expansion** (default behavior, the thing that causes the problem)

### Always GROUP BY agent_user_id — Workload Analysis

All 13 APIs use `optionalGroupBy`. Forcing agent_user_id in GROUP BY would require:
- 12 Category B (needs query change + Go re-aggregation), 1 Category C (LiveAssistStats, very complex)
- **~19-20 engineering days (4 weeks)**
- Critical correctness issue: `COUNT(DISTINCT conversation_id)` over-counting when same conversation has multiple agents
- **Conclusion: NOT recommended.** WHERE-clause filtering (one-line fix) achieves the same goal with zero API changes.

### FE Group-By Usage Patterns

**Without per-agent grouping** (summary/overview — affected by the bug):
- Performance overview cards: Assistance insights with `groupBy=[]`
- Score line chart: `groupBy=[TIME_RANGE]`
- Score metric card: `groupBy=[TIME_RANGE]`
- Conversation count chart: `groupBy=[TIME_RANGE]`
- Performance progression heatmap: `groupBy=[CRITERION, TIME_RANGE]`
- Outcome stats overview chips: `groupBy=[CRITERION]`

**With per-agent grouping** (leaderboard tables — less affected since results have per-user data):
- Agent leaderboard table: `groupBy=[AGENT, GROUP]`
- Team leaderboard: `groupBy=[GROUP]`
- Per-criterion leaderboard: `groupBy=[AGENT, TIME_RANGE]`

**Key insight**: Leaderboard summary cards (Statistics component) share the SAME request as the agent table (with `[AGENT, GROUP]`), so they're NOT affected. The bug mainly impacts Performance page overview sections that aggregate across all agents without per-agent grouping.
