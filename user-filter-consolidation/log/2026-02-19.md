# Project Log - 2026-02-19

## Progress

- Fixed B-SF-3 (Divergence 5): `ParseUserFilterForAnalytics` now uses UNION for combined user+group selections

## Details

### Bug Summary

When both `reqUsers` and `reqGroups` were provided (ACL disabled or root access), the function returned `reqUsers ∩ members(reqGroups)` (INTERSECTION) instead of `reqUsers ∪ members(reqGroups)` (UNION).

**Root cause**: Two interacting issues in `common_user_filter.go`:
1. Line 169-171: `filterUsersByGroups` unconditionally narrowed `groundTruthUsers` to only group members when `reqGroups` was present
2. Line 226: `updateGroundTruthUsers` then intersected `reqUsers` with this already-narrowed set

This meant any user in `reqUsers` who was NOT a member of `reqGroups` was silently dropped.

### Fix (2 changes in `common_user_filter.go`)

**Change 1**: Skip pre-filtering groundTruthUsers when both reqUsers and reqGroups are present:
```go
// Before:
if len(reqGroups) > 0 {
    groundTruthUsers = filterUsersByGroups(...)
}

// After:
if len(reqGroups) > 0 && len(reqUsers) == 0 {
    groundTruthUsers = filterUsersByGroups(...)
}
```

**Change 2**: For ACL-disabled/root-access cases, expand groups and UNION with users after `applyResourceACL`:
```go
if (!isACLEnabled || isRootAccess) && len(finalUsers) > 0 && len(finalGroups) > 0 {
    groupMemberUsers := filterUsersByGroups(groundTruthUsers, finalGroups, includeDirectGroupMembershipsOnly)
    finalUsers = unionUsers(finalUsers, convertLiteUsersToUsers(groupMemberUsers, customerID))
}
```

For limited access (Case 3), `applyResourceACL` already handles the UNION internally (lines 677-704).

### Tests Added (3 new tests in `common_user_filter_test.go`)

1. `B_SF_3_CombinedUserAndGroupSelectionsUseUnion` — overlapping user in group, verifies all 3 users returned
2. `B_SF_3_DisjointUserAndGroupSelectionsUseUnion` — user NOT in group (clearest UNION demo: old bug returned empty)
3. `B_SF_3_CombinedUserAndGroupUnionWithRootAccess` — same fix applies to root access (Case 2)

All 59 existing + 3 new tests pass.

### Branch & Worktree

- Branch: `xwang/fix-bsf3-union-semantics`
- Worktree: `/Users/xuanyu.wang/repos/go-servers-bsf3-fix`
- Base: `origin/main` (7b9e6079f8)

### Documentation Updated

- `user-filter-behavioral-standard.md`: Updated B-SF-3 note and Divergence 5 decision
- `implementation-plan.md`: Updated PR 1.2, PR 3.2, PR 3.4 references
- `README.md`: Added log history entry
