# Project Log - 2026-02-19

## Progress

- Implemented Phase 2 FE type layer + Agent Leaderboard column (partial)
- Created `requirements.md` with detailed product requirements
- Deep FE investigation across Performance, Leaderboard, Coaching Hub pages
- Gap analysis: identified corrections needed and remaining work
- Investigated feature flag system: config repo (`CustomerConfig.ts`) + director (`useFeatureFlag` hook)
- Updated all project docs (`fe-investigation.md`, `implementation-plan.md`, `README.md`, `requirements.md`) with full FE scope + feature flag plan

## Details

### FE changes done (5 files in `~/repos/director-quintiles`)

| File | Change |
|------|--------|
| `packages/director-api/.../apiTypes.ts` | Added `QuintileRank` import; added `quintileRank?: QuintileRank` to `QAScoreGroupBy` |
| `packages/director-api/.../transformersQAI.ts` | Added `quintileRank: groupedBy?.quintileRank` passthrough |
| `packages/director-app/.../leaderboard/types.ts` | Added `QuintileRank` import; added `quintileRank?: QuintileRank` to `LeaderboardRow` |
| `packages/director-app/.../agent-leaderboard/AgentLeaderboard.tsx` | Imported `QuintileRank` + `QuintileRankNumber`; assigned `row.quintileRank`; added column |
| `packages/director-app/.../hooks/useVisibleColumnsForLeaderboards.tsx` | Added `'quintileRank'` to `alwaysVisible` |

### Gap analysis (requirements vs current implementation)

**Needs correction:**
- Agent Leaderboard column position: currently after Performance → should be after Live Assist
- Column cell display: currently "Q1"–"Q5" → should be plain number 1–5

**Not yet implemented:**
- Shared `QuintileRankIcon` component (gold Q1, silver Q2, bronze Q3; no icon Q4/Q5)
- Icons on agent names: Agent Leaderboard, Agent Leaderboard per metric, Performance tables, Coaching Hub
- Performance → Leaderboard by criteria (2nd table): quintile column + icon (row type `LeaderboardByScorecardTemplateItemRow` needs field)
- Performance → Leaderboard per criteria (3rd table): quintile column + icon (row type `LeaderboardPerCriterionRow` needs field)
- Agent Leaderboard per metric: icon on name (row type `LeaderboardByMetricTableData` needs field)
- Coaching Hub → Recent Coaching Activities: icon with tooltip "Xth quintile based on last 7 days"

### Key investigation findings

- Performance Leaderboard by criteria uses `DirectorTable` with sticky groups; "Average Performance" is inside the sticky group
- Performance Leaderboard per criteria uses `GridTable` with `static: true` columns (different from `DirectorTable`)
- Agent Leaderboard column order: sticky → conv volume → performance → AHT → assistance → engagement → **live assist** → outcome metrics
- Coaching Hub agent name uses `AgentDetailsCell` with `SharedMenu`; QA data is per-criterion, not per-agent
- Coaching Hub tooltip "based on last 7 days" may imply a separate/fixed time window for quintile — needs product confirmation

### Feature flag investigation

- Flags defined in `config/src/CustomerConfig.ts` under `featureFlags` object (alphabetically sorted, optional boolean)
- Helper script: `yarn add-director-flag "enableQuintileRank" "description" "Director, Insights"`
- Run `yarn gen:all` to regenerate 5 JSON schema files
- Director consumes via `useFeatureFlag('enableQuintileRank')` hook — reads localStorage override → URL param → customer config
- Type safety: flag name must exist in `SchemaFeatureFlag` (auto-generated) or `LocalFeatureFlag` (manual) union types
- For immediate dev: add to `localFeatureFlags.ts`; after config PR lands, regenerate types and remove from local
- Flag should gate: `alwaysVisible` inclusion, all quintile column definitions, all `QuintileRankIcon` renderings

### PR validation (see `pr-validation.md`)

- **cresta-proto #7874** (MERGED): ✅ Correct
- **go-servers #25795** (OPEN, approved): ⚠️→✅ ClickHouse path fixed (commit `fb4e533`): added `setQuintileRankForPerAgentScores` + 2 tests
- **director** (WIP, no PR): ⚠️ Column position wrong (after Performance → should be after Live Assist), display format wrong ("Q1" → "1"), no feature flag guard, missing pages/icons
- **config** (not started): Feature flag `enableQuintileRank` not yet created

### Quintile definition revised: score bands → true percentile-based

**Problem identified:** QA scores are absolute weighted averages of normalized criterion scores (0–1 scale), NOT percentiles. Fixed score bands (80+→Q1, 60–79→Q2, etc.) fail when agents cluster in the same score range (e.g., if all agents score 0.8+, they'd all be Q1 — no differentiation).

**Solution:** True percentile-based quintiles. Rank all per-agent scores together (flat, no sub-grouping), sort descending, divide into 5 approximately equal groups:
- Q1 = top 20% (highest scores), Q5 = bottom 20%
- Algorithm: `floor(N/5)` agents per quintile, first `N%5` quintiles get one extra

**BE changes in go-servers (`retrieve_qa_score_stats.go`):**
- Removed `ScoreToQuintileRank(score)` (fixed score-band mapping)
- Rewrote `setQuintileRankForPerAgentScores(response)`: collects all per-agent scores, sorts descending, distributes into quintiles evenly
- Both Postgres path (line 297) and ClickHouse path (line 707) call the same function
- 7 unit tests: 10-agent even split, 3-agent small group, 7-agent uneven, non-agent rows untouched, all-same-score, single agent, nil safety
- 2 ClickHouse tests updated for percentile-based expectations
- Fixed struct literal bug: `qaScoreStatsRow{agentUserID:...}` → `qaScoreStatsRow{clickhouseKeyTimeRow: clickhouseKeyTimeRow{agentUserID:...}}`
- All tests pass ✅
