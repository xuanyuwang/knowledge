# Project Log - 2026-02-23

## Progress

- All 4 remaining large customers completed their parallel backfill workflows
- Appeal scorecard cleanup is fully done: 95/95 customers across all 8 clusters
- Verified appeal scorecards (types 1, 2, 3) are correctly filtered from ClickHouse post-backfill
- Spot-checked care-oregon: 0/10 appeal scorecards in CH, regular scorecards present

## Final Completion

All windowed parallel backfill workflows completed overnight:

| Customer | Cluster | Windows | Last Workflow Duration | Status |
|----------|---------|---------|----------------------|--------|
| spirit | us-east-1-prod | 5 × 10-day | ~3-4h per window | Complete |
| hilton | voice-prod | 9 × 5-day | ~2-5h per window | Complete |
| marriott | us-east-1-prod | 5 × 10-day | ~4-7h per window | Complete |
| united-east | us-east-1-prod | 10 × 5-day | ~6-8h per window | Complete |

Zero failures across all workflows. All ran at attempt=1 with the windowed approach.

### Heartbeat Progress Monitoring

Used `temporal workflow describe` to track per-workflow progress via heartbeat details:
```
LastHeartbeatDetails: [{"State":{"ReindexedConversations":350700,"FailedConversations":0,"TotalConversationCount":399042}}]
```

United-east final batch (8 parallel windows) went from ~70-88% to 100% over ~2-3 hours.
Marriott's last workflow (640K conversations) completed at ~93% when last checked.

## Verification: Appeal Scorecards Filtered from ClickHouse

Verified that the backfill correctly excludes appeal scorecards (proto `ScorecardType` 1=APPEAL_ORIGINAL_REPLICA, 2=APPEAL_REQUEST, 3=APPEAL_RESOLVE) from ClickHouse.

### Postgres Appeal Scorecard Counts (Jan 1 – Feb 21)

Checked 9 customers + care-oregon:

| Customer | Cluster | Appeal Scorecards | Details |
|----------|---------|:-----------------:|---------|
| propel | us-east-1-prod | 64 | 22 replica, 22 request, 20 resolve |
| care-oregon | us-west-2-prod | 49 | 18 replica, 18 request, 13 resolve |
| rentokil | us-east-1-prod | 19 | 9 replica, 10 request |
| brinks | voice-prod | 2 | 1 replica, 1 request |
| spirit | us-east-1-prod | 0 | |
| guitar-center | us-east-1-prod | 0 | |
| nclh | us-east-1-prod | 0 | |
| greenix | us-east-1-prod | 0 | |
| hilton | voice-prod | 0 | |
| holidayinn | voice-prod | 0 | |

### ClickHouse Spot-Check: care-oregon (us-west-2-prod)

- Picked 10 appeal scorecard IDs (type 1) from Postgres → **0/10 found in ClickHouse** (correctly filtered)
- Picked 5 regular submitted scorecard IDs from Postgres → **3/5 found in ClickHouse** (present as expected; some filtered by other reindex criteria unrelated to appeals)

ClickHouse `scorecard` table has no `scorecard_type` column — appeal scorecards are filtered out during reindex before insertion.

## Spirit Backfill Verification (ClickHouse vs Postgres)

### Overall Counts (Jan 1 – Feb 21)

| Metric | Before Delete (Feb 21) | After Backfill (now) | Delta |
|--------|:----------------------:|:--------------------:|:-----:|
| Scorecards | 1,538,150 | 1,634,498 | +96,348 (+6.3%) |
| Scores | 4,678,595 | 5,131,036 | +452,441 (+9.7%) |

Daily distribution verified: all 51 days (Jan 1 – Feb 20) have data, no gaps. Counts range ~15K–57K/day with natural variation.

Counts are higher than pre-delete because Spirit had 0 appeal scorecards — the increase is from new scorecards generated between the original indexing and the re-backfill.

### Template `019a4f71-f28d-720c-bfb9-511d312e1e92` — Missing from ClickHouse

Investigated "Guest Relations Performance Template CC- Manual" (template type=2):

| Source | Count | conversation_id |
|--------|:-----:|:---------------:|
| Postgres | 740 | **all empty** (740/740) |
| ClickHouse | 0 | N/A |

- `scorecards.scorecard_type` = NULL for all 740 (NOT appeal scorecards — scorecard_type=2 would be APPEAL_REQUEST)
- `submission_source` = 2 for all 740
- Template `type=2` is the **template type** (manual), distinct from the `ScorecardType` proto enum

### All type=2 (manual) templates have the same pattern

| Template Type | Templates | Scorecards | No conversation_id | Has conversation_id |
|:---:|:---:|:---:|:---:|:---:|
| 1 (auto) | 29 | 131,095 | 0 | **131,095 (100%)** |
| 2 (manual) | 8 | 11,237 | **11,237 (100%)** | 0 |

All 5 active type=2 templates with data in range:

| Template | Scorecards |
|----------|:---:|
| Social Media Public Canned Response Audit | 4,977 |
| Guest Relations Performance Template CC- Manual | 3,700 |
| Social Media Performance Template CC- Manual | 2,210 |
| NH Guest Relations Performance Template CC- Manual | 348 |
| NH Social Media Performance Template CC- Manual | 2 |

### Root Cause: No Temporal workflow handles process scorecards

Investigated both relevant Temporal workflows — neither can index process scorecards to ClickHouse.

**Workflow 1: `reindex-conversations`** (what our `backfill.sh` triggers via `cron-batch-reindex-conversations`)

Purpose: Read existing scorecards from Postgres → write to ClickHouse.

- `conversation_reindexer.go:188-200`: Discovers conversations from `app.chats` with `conversation_id IS NOT NULL`
- For each conversation, finds scorecards WHERE `conversation_id = discovered_conversation_id`
- Process scorecards have no `conversation_id` → never discovered

**Workflow 2: `BackfillScorecardsWorkflow`** (separate workflow, triggered via JobService)

Purpose: Auto-score conversations against templates → create new scorecards in Postgres → optionally reindex to ClickHouse.

Three independent barriers to process scorecards:
1. **Conversation discovery** (`time_range_provider.go:18-24`): Same `app.chats` query with `conversation_id IS NOT NULL AND agent_user_id IS NOT NULL`
2. **Hardcoded flag** (`template_processor.go:441`): `UpdateHistoricScorecardScores(... false /* isProcessScorecard */ ...)` — no config to change
3. **Proto payload** (`BackfillScorecardsPayload`): Only fields are `start_time`, `end_time`, `scorecard_template`, `audience`, `include_dev_users`, `skip_reindex_conversations`, `source_job`. No process scorecard option.

**ClickHouse write layer DOES support process scorecards** (`scorecard_score.go`):
- `findShardForProcessScorecard()` — shards by `scorecard_time` instead of `conversation_start_time`
- `WriteScorecards()` / `WriteScores()` / `DeleteScorecard*()` all accept `isProcessScorecard` flag
- But no workflow passes `true` for this flag

**Conclusion:** Indexing process scorecards to ClickHouse would require a new workflow or significant extension to an existing one. This is a pre-existing gap, not a backfill regression.

## Summary

### Appeal Scorecard Cleanup — Complete

- **Deletion:** 95/95 customers, ~70.5M scorecards + ~650.5M scores removed
- **Backfill:** 95/95 customers re-indexed with clean data (no appeal scorecards)
- **Duration:** Feb 21 (start) → Feb 23 (complete), ~2.5 days total
- **Strategy evolution:** Full-range → windowed sequential → windowed parallel (weekend)
