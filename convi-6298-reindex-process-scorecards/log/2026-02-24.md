# Project Log - 2026-02-24

## Progress

- Implemented full CONVI-6298 across cresta-proto and go-servers repos
- All changes made in isolated git worktrees
- **Direction change #1**: Switched from separate `JOB_TYPE_REINDEX_PROCESS_SCORECARDS` to extending `JOB_TYPE_REINDEX_CONVERSATIONS` with a `reindex_scorecard_types` field
- **Direction change #2**: After review, decided to create a new scorecard-centric workflow (`JOB_TYPE_REINDEX_SCORECARDS`) instead — see "Final Direction" below

## Investigation: Process Scorecard CH Sync Paths

Found 4 code paths that write scorecard data to CH:
1. **CreateScorecard async work** — the only real-time path that handles process scorecards (`!isConvoTemplate` = dynamic)
2. **BatchIndexConversations** — explicitly filters OUT process scorecards (`scorecard_type IS NULL OR = 0`)
3. **AutoQA autoscoring** — hardcodes `isProcessScorecard=false`
4. **ReindexProcessScorecards** (new, CONVI-6298) — hardcodes `true`

Key finding: process scorecards can go out of sync when the async goroutine in CreateScorecard fails, and before CONVI-6298 there was no way to recover them.

## Investigation: backfillscorecards vs reindexconversations

Explored whether `backfillscorecards` is a better home for process scorecard reindexing:

- **backfillscorecards**: Creates/updates scorecards in PG via AutoQA scoring engine. Optionally reindexes to ES (explicitly skips CH). Conversation-centric.
- **reindexconversations**: Syncs existing PG data → CH/ES via `BatchIndexConversations`. Conversation-centric.

Neither is a perfect fit because:
- `backfillscorecards` is about *creating* scorecard data, not syncing existing data to CH
- `reindexconversations` is conversation-centric — process scorecards are not about conversations

## Final Direction: New Scorecard-Centric Workflow

Create a new `JOB_TYPE_REINDEX_SCORECARDS` with its own workflow (`reindexscorecards/` package):

**Rationale**:
- Clean separation: `reindexconversations` stays conversation-centric, new workflow is scorecard-centric
- Extensible: starts with process scorecards, could later add direct conversation scorecard → CH path
- Proper naming: the package name matches what it does

**Changes needed**:

| Repo | Change |
|------|--------|
| cresta-proto | New `JOB_TYPE_REINDEX_SCORECARDS` enum value |
| cresta-proto | New `ReindexScorecardsPayload` message (time range, `repeated ScorecardTemplateType`, batch size, clean_up flag) |
| cresta-proto | New `ReindexScorecardsWorkflowInput` workflow input proto |
| go-servers | New `temporal/ingestion/reindexscorecards/` package (const, workflow, activity) |
| go-servers | New job handler for `JOB_TYPE_REINDEX_SCORECARDS` |
| go-servers | Registration entry for new task queue |
| go-servers | Update `batch-reindex-conversations/task.go` cron to create new job type for process mode |

**Revert**: All changes to `reindexconversations` package (workflow.go, activity.go, const.go, process_scorecard_activity.go) and the `reindex_scorecard_types` field on `ReindexConversationsPayload`.

## Current State of PRs

Both PRs on `convi-6298/reindex-process-scorecards` branch currently have the "extend reindexconversations" approach pushed. These need to be updated to the new scorecard-centric workflow approach next session.

- cresta-proto PR #7919
- go-servers PR #25916
