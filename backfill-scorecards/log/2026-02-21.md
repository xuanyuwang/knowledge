# Project Log - 2026-02-21

## Progress

- Executed appeal scorecard cleanup across all 8 production clusters
- All clusters processed; 95/95 customers completed
- Oportun handled via chunked 1-day deletes (51 days) + full-range sweep

## Cluster Results

| Cluster | Customers | Completed | Scorecards Removed | Scores Removed | Notes |
|---------|-----------|-----------|-------------------|----------------|-------|
| voice-prod | 17 | 17/17 | ~18.9M | ~178.9M | gardner-white added as unmapped |
| us-east-1-prod | 44 | 44/44 | ~22.1M | ~154.8M | chime added as unmapped |
| us-west-2-prod | 30 | 30/30 | ~27.2M | ~297.6M | oportun chunked 1-day deletes, cba-japan unmapped |
| chat-prod | 3 | 3/3 | ~2.0M | ~18.0M | |
| eu-west-2-prod | 0 | - | 0 | 0 | No scorecard data in range |
| schwab-prod | 1 | 1/1 | ~267K | ~1.2M | |
| ap-southeast-2-prod | 0 | - | 0 | 0 | No scorecard data in range |
| ca-central-1-prod | 0 | - | 0 | 0 | No scorecard data in range |
| **Total** | **95** | **95/95** | **~70.5M** | **~650.5M** | |

## Issues Encountered

### ON CLUSTER Mutation Replication Delays
- ON CLUSTER operations create mutations on all 9 nodes (3 shards x 3 replicas)
- Small databases (cvs-sandbox: 4 scorecards) were blocked for 10+ minutes by mutation queue
- Solution: killed stuck mutations, issued fresh ON CLUSTER deletes, proceeded to backfill without waiting for full mutation completion (mutations only affect parts existing at creation time, not new inserts)

### Oportun Deferred
- 15.6M scorecards + 232.9M scores - too large for single mutation within 600s timeout
- Blocked the entire cluster's mutation queue
- Killed mutations and deferred for later chunked deletion
- Strategy: needs 1-day sequential deletes or even smaller batches

### Unmapped Databases
- Some databases not in `backfill_tracking.json` (new customers added after Jan 2026 backfill)
- Handled by querying `customer_id, profile_id` from ClickHouse scorecard table, adding to tracking
- Affected: gardner-white (voice-prod), chime (us-east-1-prod), cba-japan (us-west-2-prod)

## Remaining Work

1. **Verify Temporal workflows**: All backfill jobs were submitted but run asynchronously via Temporal. The `after_counts` in tracking files mostly show 0 because they were captured before workflows completed. Spot-check should be done later.

## Connection Strings Used

| Cluster | CH Host | Password |
|---------|---------|----------|
| voice-prod | clickhouse-conversations.voice-prod.internal.cresta.ai | jIKiJqSXovuvntudQHuMqwD0PWaJ8buU |
| us-east-1-prod | clickhouse-conversations.us-east-1-prod.internal.cresta.ai | ItVIZdiPT8XQmD5Yox16ROpdNcjJYEEx |
| us-west-2-prod | clickhouse-conversations.us-west-2-prod.internal.cresta.ai | 2S57v6RKRrpTtWxgZjdPQtjH3lTRp8Rv |
| chat-prod | clickhouse-conversations.chat-prod.internal.cresta.ai | sLNi6hIM82gngG5N0iMFM9jT5thxEQVc |
| eu-west-2-prod | clickhouse-conversations.eu-west-2-prod.internal.cresta.ai | RfIJ5vCxJiGcFUNAW9shBYUcqRMzYWMr |
| schwab-prod | clickhouse-conversations.schwab-prod.internal.cresta.ai | dtNMGOkdvir69WnJ4LNSH7LCBPJrOQON |
| ap-southeast-2-prod | clickhouse-conversations.ap-southeast-2-prod.internal.cresta.ai | eBm6QVnOQsGNwjJwE80xdPULz24Gm6Vj |
| ca-central-1-prod | clickhouse-conversations.ca-central-1-prod.internal.cresta.ai | SSzkV8B7WQ9jj76xXEo9UGehyIMPKwpC |
