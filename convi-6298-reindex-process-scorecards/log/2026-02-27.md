# Project Log - 2026-02-27

## Progress

- Fixed type error in activity.go: `[]*scoring.HistoricScorecardScores` → `[]*hmodel.ScorecardScores`
- Removed heartbeat resume logic (OFFSET pagination unreliable with mutable data)
- Kept heartbeat for progress visibility: `"type 1/2 (PROCESS): 50/200 scorecards"`
- Rebased onto main (cresta-proto v2.0.587 merged) — all packages build
- Updated go-servers PR #25916 description
- Updated project README with final state
- Added `scorecard_template_ids` proto field (cresta-proto PR #7954) + activity filtering logic (go-servers)
- Replied to 3 review comments on cresta-proto PR #7919 (batch_size tradeoffs, template IDs, time filtering)

## Details

### Refactor: Skip historic schema, reconstruct from director data

Skip reading from `historic.scorecard_scores` and instead reconstruct from `director.scores` + template structure.

**Before**: `fetchHistoricScores()` → read from `historic.scorecard_scores` table
**After**: `buildHistoricScoresFromDirector()`:
1. `fetchDirectorScores()` — queries `director.scores` by customer/profile/scorecard_id
2. `fetchTemplateRevision()` — queries `director.scorecard_template_revisions`
3. `scoring.ParseScorecardTemplateStructure()` — parses template JSON
4. `scoring.GenerateHistoricScorecardScores()` — pure computation, returns `[]*hmodel.ScorecardScores`

### Heartbeat: progress only, no resume

OFFSET-based pagination is broken for resume when underlying data changes between runs. Removed all resume logic (`HeartbeatDetails` struct, `HasHeartbeatDetails`/`GetHeartbeatDetails`, skip-on-resume). Kept `activity.RecordHeartbeat` with a progress string for Temporal UI visibility and worker liveness detection. On retry, the activity reprocesses from scratch (safe: CH `ReplacingMergeTree` deduplicates).

### Rebase onto main

cresta-proto PR #7919 merged → main got v2.0.587 via auto-deps update. Rebased feature branch, skipped the now-redundant go.mod update commit. Bazel build passes for all packages (`reindexscorecards`, `jobhandler`, `registration`, `batch-reindex-conversations`).

### New proto field: `scorecard_template_ids`

Added `repeated string scorecard_template_ids = 6` to `ReindexScorecardsPayload` in `job_payload.proto`. Filtering logic:
- Both `scorecard_types` AND `scorecard_template_ids` set → AND (must match both)
- Only `scorecard_types` set → filter by type only
- Only `scorecard_template_ids` set → resolve types from template IDs, then filter by both
- Neither set → defaults to PROCESS scorecards only

Activity changes:
- Refactored `countScorecards`/`fetchScorecardBatch` to use shared `scorecardQuery()` builder that conditionally adds `s.template_id IN ?`
- Added `resolveTypesFromTemplateIDs()` — discovers which types exist for given template IDs (needed because CH writes require knowing `isProcessScorecard`)

### Batch size: proto field vs env var analysis

PR review asked about tradeoffs. Current approach (both) matches `ReindexConversationsPayload` pattern:
- Env var → global default (50), tunable without code change
- Proto field → per-job override for one-off backfills
- Precedent: `reindexconversations` uses same dual approach; `backfillsteps` uses env-only

### Replied to review comments on PR #7919

- **batch_size** (line 3315): Explained dual approach (env var default + proto override), listed pros/cons, cited `ReindexConversationsPayload` precedent
- **template names** (line 3304): Pointed to new PR #7954 with `scorecard_template_ids`
- **time filtering** (line 3295): Confirmed `s.created_at` on `director.scorecards`, consistent with reindex conversations

## Next Steps

- [ ] cresta-proto PR #7954 review/merge (`scorecard_template_ids`)
- [ ] Code review approval on go-servers PR #25916
- [ ] Staging test with known time range
- [ ] Verify CH data matches PG
