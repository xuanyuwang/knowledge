# Project Log - 2026-02-24

## Progress

- Implemented full CONVI-6298 across cresta-proto and go-servers repos
- All changes made in isolated git worktrees
- **Direction change**: Switched from separate job type to extending `JOB_TYPE_REINDEX_CONVERSATIONS` with a `reindex_scorecard_types` field

## Investigation: Process Scorecard CH Sync Paths

Found 4 code paths that write scorecard data to CH:
1. **CreateScorecard async work** — the only real-time path that handles process scorecards (`!isConvoTemplate` = dynamic)
2. **BatchIndexConversations** — explicitly filters OUT process scorecards (`scorecard_type IS NULL OR = 0`)
3. **AutoQA autoscoring** — hardcodes `isProcessScorecard=false`
4. **ReindexProcessScorecards** (new, CONVI-6298) — hardcodes `true`

Key finding: process scorecards can go out of sync when the async goroutine in CreateScorecard fails, and before CONVI-6298 there was no way to recover them.

## Approach Change: Extend Existing Job Type

Instead of creating a separate `JOB_TYPE_REINDEX_PROCESS_SCORECARDS`, we now extend `JOB_TYPE_REINDEX_CONVERSATIONS`:

**Why**: Simpler architecture — one job type, one workflow, branching on which scorecard types to reindex.

**Proto change**: Added `repeated ScorecardTemplateType reindex_scorecard_types = 13` to `ReindexConversationsPayload` (reuses existing `ScorecardTemplateType` enum from `coaching/scorecard_template.proto`).

**Backward compat**: Empty list = conversation only (default behavior unchanged).

### Reverted (old approach)
- Removed `JOB_TYPE_REINDEX_PROCESS_SCORECARDS = 61` from `job.proto` (reserved 61)
- Removed `ReindexProcessScorecardsPayload` message + oneof field 59 from `job_payload.proto` (reserved 59)
- Deleted `reindex_process_scorecards.proto` workflow input
- Deleted `temporal/ingestion/reindexprocessscorecards/` package (const, workflow, activity)
- Deleted `reindex_process_scorecards_handler.go` job handler
- Removed registry entry for old job type
- Removed registration entry for old task queue

### New approach changes

**cresta-proto:**
- `job_payload.proto`: Added `repeated cresta.v1.coaching.ScorecardTemplateType reindex_scorecard_types = 13` to `ReindexConversationsPayload`
- Added import of `cresta/v1/coaching/scorecard_template.proto`

**go-servers — reindexconversations package:**
- `const.go`: Added `ReindexProcessScorecardsBatchSize` env flag
- `activity.go`: Added `ClickHouseClient` field to `Activities` struct
- `process_scorecard_activity.go` (new): `ReindexProcessScorecardsActivity` method — queries PG for process scorecards, writes to CH via `WriteScores`/`WriteScorecards` with `isProcessScorecard=true`
- `workflow.go`: `Workflow` now branches based on `reindex_scorecard_types`:
  - Empty or contains CONVERSATION → run `ReindexConversationsActivity`
  - Contains PROCESS → run `ReindexProcessScorecardsActivity`
  - Both → run sequentially (conversation first, then process)
  - Added `resolveReindexScope()` helper

**go-servers — registration:**
- `registration.go`: `reindexConversationsRegistration` now accepts `*clickhouseconvoclient.ClickHouseClient` (DI already knows how to provide it)
- Removed old `reindexprocessscorecards.TaskQueueName` registration

**go-servers — cron task:**
- `task.go`: Simplified to single code path — `Run()` creates one `JOB_TYPE_REINDEX_CONVERSATIONS` job with `reindex_scorecard_types` set based on `REINDEX_MODE`
- Added `mapModeToScorecardTypes()` helper
- Removed `runConversationReindex()`/`runProcessScorecardsReindex()` split
