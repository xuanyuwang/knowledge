# Project Log - 2026-02-09

## Progress

- Re-evaluated the entire project against the current go-servers codebase
- Created `evaluation-2026-02-09.md` with full findings

## Details

### Key Findings

1. **The original unification plan (merge into shared/user-filter) has not been executed.** Instead, the team took an incremental approach: migrating APIs one by one to `ParseUserFilterForAnalytics`.

2. **Migration is ~41% complete**: 12 out of ~29 APIs now use `ParseUserFilterForAnalytics`. 17 APIs still use the old 3-step pattern (ApplyResourceACL + ListUsersMappedToGroups + MoveFiltersToUserFilter).

3. **Feature flag still active**: `ENABLE_PARSE_USER_FILTER_FOR_ANALYTICS` gates the new path.

4. **All analysis documents remain accurate**: The unused params, cache analysis, and function comparison docs are still valid.

5. **New developments since analysis**: `ShouldQueryAllUsers` flag, `ApplyUserFilterFromResult` helper, UNION semantics fix for group expansion.

### Recommendation (revised)

Unification first approach is better — avoids touching ~17 APIs twice. Build behavioral standard first, align with team, then unify.

### Behavioral Standard Created (v2 — updated with non-test evidence)

Created `user-filter-behavioral-standard.md` with:
- 45+ numbered behaviors across 19 sections
- Evidence from: unit tests, implementation code, AND caller usage patterns
- New sections added from non-test code review:
  - **Section 11: Group Hierarchy and Child Teams** (B-GH-1 to B-GH-4) — from `ListGroups` implementation
  - **Section 13: Caller Contract** (B-CC-1 to B-CC-5) — from `retrieve_*_stats.go` caller patterns
  - **Section 18: Profile Scoping** (B-PS-1, B-PS-2) — from cross-profile bug comment
- Key behaviors found ONLY in implementation code (not tests):
  - B-CF-1 divergence: old pattern uses UNION for user+group, new uses INTERSECTION (most significant)
  - B-SO-1: sort key divergence (Name vs FullName)
  - B-DU-4: ListUsersMappedToGroups hardcodes IncludeInactiveUsers=true
  - B-CC-2: missing UserNameToGroupNamesMap entries silently drop user stats from response
  - B-GF-6: invalid group names silently skipped in filterUsersByGroups
  - B-SO-3: non-deterministic map iteration in unionUsers/convertLiteUsersToUsers
- 9 behavioral divergences identified (up from 6), including `hasAgentAsGroupByKey` coupling
- Appendix B lists 15 behaviors found only from non-test code

### hasAgentAsGroupByKey Analysis & Removal Proposal (v3)

Added Sections 20 and 21 to the behavioral standard:

**Section 20 — Remove `hasAgentAsGroupByKey` from user filter:**
- Flag bundles 3 unrelated concerns: root/default inclusion, force direct-only, group filter bypass
- Name describes caller's grouping strategy, not a user filter behavior
- Proposed: user filter returns complete data, callers post-process

**Section 21 — Post-processing utilities:**
- `StripRootAndDefaultGroups` — strip root/default from user-to-group maps
- `FilterGroups` / `FilterMappingByGroups` — restrict groups to an allowlist
- `ClearGroupMembers` — strip membership data for responses
- `UserNamesFromResult` / `UserIDsFromResult` — extract names/IDs for coaching
- `ApplyToQuery` — apply result to WHERE clause (replaces ApplyUserFilterFromResult)
- Documented 4 typical caller patterns: agent leaderboard, team leaderboard, time-range only, coaching

**Updated existing sections:**
- Section 2 (Inputs): reorganized into 4 categories (Scoping Context, User Selection, Population Filter, Membership Resolution). Identified 3 redundancies: `listAgentOnly` ≡ `Roles=[AGENT]`, `excludeDeactivatedUsers` ≡ `State=ACTIVE`, `DirectTeamOnly` ≡ `includeDirectGroupMembershipsOnly`. Proposed unifying each pair.
- Section 3 (Outputs): restructured into Core Outputs (complete data) + Derived Outputs (via utilities)
- Section 10 (B-GM-1 through B-GM-6): rewritten to remove `hasAgentAsGroupByKey` coupling
- Section 19: added Divergence 9
- Section 4 (B-ACL-4, B-ACL-5): added explanation of why UNION semantics and group expansion are required, with concrete examples of what goes wrong without them (intersection bug, data leakage, silent data loss)
- Section 5 (B-GT-1, B-GT-3, B-GT-4): added explanation of why ground truth is fetched first instead of gradually adding users. Documented three bug classes: role filtering bypass, status filtering bypass, inconsistent metadata. Added concrete examples of limited-access data leakage and two-user-list divergence.
