# Project Log - 2026-02-18

## Progress

- Changed proto `quintile_rank` field from `int32` to `QuintileRank` enum type.
- Implemented BE Phase 1.2–1.4: `ScoreToQuintileRank`, `setQuintileRankForPerAgentScores`, wired into `retrieveQAScoreStatsInternal`, 12 tests passing.
- Investigated agent tier logic — documented in `agent-tier-logic.md`.
- Verified QA score is 0–1 scale — proto comment confirms it, ClickHouse raw data is 0–100 but normalized via `score/100.` in query.

## Details

### Proto change: int32 → QuintileRank enum

**File:** `cresta-proto/cresta/v1/analytics/qa_stats.proto` (worktree: `cresta-proto-quintiles`)

Added `enum QuintileRank` before `QAScoreGroupBy`:
```protobuf
enum QuintileRank {
  QUINTILE_RANK_UNSPECIFIED = 0;
  QUINTILE_RANK_1 = 1;  // 80+
  QUINTILE_RANK_2 = 2;  // 60-79
  QUINTILE_RANK_3 = 3;  // 40-59
  QUINTILE_RANK_4 = 4;  // 20-39
  QUINTILE_RANK_5 = 5;  // 0-19
}
```

Changed field 7 in `QAScoreGroupBy`:
```diff
- int32 quintile_rank = 7 [(google.api.field_behavior) = OUTPUT_ONLY];
+ QuintileRank quintile_rank = 7 [(google.api.field_behavior) = OUTPUT_ONLY];
```

### Docs updated

- `implementation-plan.md` — `ScoreToQuintileRank` returns `analyticspb.QuintileRank` instead of `int32`.
- `pr-phase-1.1.md` — PR description reflects enum type.

### BE Phase 1.2–1.4: Implemented QuintileRank in go-servers

**Worktree:** `go-servers-quintiles` (branch `feature/agent-quintiles`)

**Proto bumped:** `cresta-proto/v2` v2.0.523 → v2.0.534

**Changes in `retrieve_qa_score_stats.go`:**

1. Added `ScoreToQuintileRank(score float32) analyticspb.QuintileRank` — pure switch on thresholds (0.8, 0.6, 0.4, 0.2).
2. Added `setQuintileRankForPerAgentScores(response)` — iterates `QaScoreResult.Scores`, sets `GroupedBy.QuintileRank` where `GroupedBy.User != nil`.
3. Wired `setQuintileRankForPerAgentScores(result)` in `retrieveQAScoreStatsInternal` inside the AGENT branch only (not AGENT_TIER or other groupings).

**Tests in `retrieve_qa_score_stats_test.go`:**

- `TestScoreToQuintileRank` — 10 boundary cases (0, 0.19, 0.2, 0.39, 0.4, 0.59, 0.6, 0.79, 0.8, 1.0)
- `TestSetQuintileRankForPerAgentScores/OnlyAgentRowsGetQuintileRank` — agent gets quintile, non-agent stays UNSPECIFIED
- `TestSetQuintileRankForPerAgentScores/MultipleAgentsAcrossAllBands` — 5 agents spanning all 5 bands
- `TestSetQuintileRankForPerAgentScores/NilSafety` — nil response, nil QaScoreResult, empty Scores
- `TestAggregateTopAgentsResponse_NoQuintileRankLeakage` — AGENT_TIER path does not carry stale quintile rank

All 14 tests pass.

### QA score scale verification

Confirmed `QAScore.Score` is **0–1 scale**:

| Layer | Scale | Evidence |
|-------|-------|----------|
| Proto definition | 0–1 | `qa_stats.proto:168`: *"Is a number between 0 and 1"* |
| ClickHouse raw data | 0–100 | `score` column in scorecard table |
| ClickHouse query | 0–1 | `SUM(score/100.)` normalizes at query time |
| `safeDivideFloat(weightedSum, weightSum)` | 0–1 | Preserves scale through aggregation |

The quintile thresholds (0.8, 0.6, 0.4, 0.2) in `ScoreToQuintileRank` are correct.

### Agent tier logic investigation

Documented in `agent-tier-logic.md`. Key findings:
- Tiers are **volume-weighted** (by TotalScorecardCount), not count-based.
- Split: 25% bottom, 50% average, 25% top — by cumulative conversation volume.
- Agents sorted by QA score ascending, then binary search on cumulative volume for cutoff indices.
- Quintile rank (absolute score bands) is independent from agent tiers (relative volume-weighted ranking).

### PR opened

- **go-servers PR:** https://github.com/cresta/go-servers/pull/25795
  - Branch: `feature/agent-quintiles`
  - 2 files, +161 lines (no go.mod change — main already had proto v2.0.534)

### FE investigation (Phase 2 prep)

- Created director worktree: `director-quintiles` (branch `feature/agent-quintiles`)
- `@cresta/web-client` is at 2.0.534 — needs verification that `QuintileRank` is in generated types
- No references to `quintileRank` exist in director yet
- Documented full FE data flow and files to change in `fe-investigation.md`
- Key insertion points:
  - `apiTypes.ts` + `transformersQAI.ts`: add type and transformer mapping
  - `LeaderboardRow` in `types.ts`: add field
  - `AgentLeaderboard.tsx:239`: assign `row.quintileRank` in QA score loop
  - Column definitions in `utils.tsx`, `useColumnsFromScorecardTemplate`, `useLeaderboardPerCriterionColumns`
  - New `QuintileRankBadge` display component

## Next Steps

1. Get go-servers PR reviewed and merged.
2. ~~Verify `@cresta/web-client@2.0.534` includes `QuintileRank` types~~ — confirmed, no dep bump needed.
3. Implement FE changes per `fe-investigation.md`.
